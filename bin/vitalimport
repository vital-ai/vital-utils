#!/usr/bin/env groovy

import static groovy.io.FileType.FILES

if ( ! System.getenv('VITAL_HOME') ) {
	System.err.println("No VITAL_HOME environment variable set!");
	return
}

def vitalhome = System.getenv('VITAL_HOME')

// compare location of script with vital home to help detect if wrong directory set


def homeDir = vitalhome + "/" + "vitalutil" + "/"

def mainClass = 'ai.vital.vitalutilcommands.VitalImport'

List jars = []


new File(vitalhome, "vitalsigns/command").eachFileRecurse(FILES) {
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}

new File(homeDir, 'command').eachFileRecurse(FILES) {
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}

new File(vitalhome, 'vital-domain').eachFile(FILES){
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}


new File(vitalhome, "vitalsigns/lib").eachFileRecurse(FILES) {
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}

new File(vitalhome, "vitalservice").eachFileRecurse(FILES) {
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}

new File(vitalhome, "vital-lucene").eachFileRecurse(FILES) {
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}

if( new File(vitalhome, "vital-dynamodb").exists() ) {
  new File(vitalhome, "vital-dynamodb").eachFileRecurse(FILES) {
    if(it.name.endsWith(".jar")) {
      jars.add(it.absolutePath)
    }
  }
}

File tripleStoreMod = new File(vitalhome, 'vital-triplestore')
if(tripleStoreMod.exists() && tripleStoreMod.isDirectory()) {
  tripleStoreMod .eachFileRecurse(FILES) {
    if(it.name.endsWith(".jar")) {
      jars.add(it.absolutePath)
    }
  }
}

File sqlMod = new File(vitalhome, 'vital-sql')
if(sqlMod.exists() && sqlMod.isDirectory()) {
  sqlMod .eachFileRecurse(FILES) {
    if(it.name.endsWith(".jar")) {
      jars.add(it.absolutePath)
    }
  }
}


new File(vitalhome, "domain-groovy-jar").eachFile(FILES) {
  if(it.name.endsWith(".jar")) {
      jars.add(it.absolutePath)
  }
}


new File(homeDir, "lib").eachFileRecurse(FILES) {
  if(it.name.endsWith(".jar")) {
    jars.add(it.absolutePath)
  }
}

//println System.getenv("PATH");

List cmd = ['java', '-cp', (String)jars.join(File.pathSeparator), mainClass];

for(String a : args) {
	cmd.add(a);
}

//println(cmd);

def process = new ProcessBuilder(cmd).redirectErrorStream(true).start()
process.inputStream.eachLine {println it}